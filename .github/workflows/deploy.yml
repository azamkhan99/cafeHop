name: Deploy with Config

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Allow GitHub Actions to write to the repository
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Remove config.js from .gitignore for deployment
        run: |
          # Remove config.js from .gitignore BEFORE generating it
          # This ensures the deployment action will include it
          if [ -f .gitignore ]; then
            # Remove both /config.js and config.js patterns
            sed -i.bak '/^\/config\.js$/d; /^config\.js$/d' .gitignore || sed -i '' '/^\/config\.js$/d; /^config\.js$/d' .gitignore || true
            echo "‚úÖ Removed config.js from .gitignore"
            echo "üìã Updated .gitignore:"
            cat .gitignore
          fi

      - name: Generate config.js from secrets
        run: |
          if [ -z "${{ secrets.API_GATEWAY_URL }}" ]; then
            echo "‚ùå ERROR: API_GATEWAY_URL secret is not set!"
            echo "Please go to Settings > Secrets and variables > Actions and add API_GATEWAY_URL"
            exit 1
          fi
          # Generate as app-config.js (not in .gitignore) so it gets deployed
          # Then create symlink config.js for backward compatibility
          cat > app-config.js << EOF
          // Configuration file - Generated from GitHub Secrets during deployment
          
          window.APP_CONFIG = {
              API_GATEWAY_URL: '${{ secrets.API_GATEWAY_URL }}'
          };
          EOF
          # Also create config.js (symlink or copy) for the HTML file
          cp app-config.js config.js
          chmod 644 app-config.js config.js
          echo "‚úÖ Generated app-config.js and config.js ($(wc -c < app-config.js) bytes)"

      - name: Verify config.js was generated
        run: |
          if [ -f config.js ]; then
            echo "‚úÖ config.js generated successfully"
            # Don't print the full content to avoid exposing secrets in logs
            grep -q "API_GATEWAY_URL" config.js && echo "‚úÖ API_GATEWAY_URL found in config.js" || echo "‚ùå API_GATEWAY_URL not found"
            echo "üìÑ File size: $(wc -c < config.js) bytes"
            echo "üìÅ Files in root directory:"
            ls -la *.js *.html 2>/dev/null || echo "No matching files found"
          else
            echo "‚ùå config.js was not generated!"
            exit 1
          fi

      - name: Verify config.js will be deployed
        run: |
          echo "üîç Final verification before deployment:"
          echo "üìÅ Checking config.js:"
          ls -la config.js 2>/dev/null && echo "‚úÖ config.js exists" || echo "‚ùå config.js missing!"
          echo ""
          echo "üîç Checking if config.js is ignored by git:"
          git check-ignore -v config.js && echo "‚ö†Ô∏è WARNING: config.js is still ignored!" || echo "‚úÖ config.js is NOT ignored - will be deployed"
          echo ""
          echo "üì¶ Files that will be deployed:"
          find . -type f \( -name "*.js" -o -name "*.html" \) | grep -v node_modules | head -20

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          exclude_assets: 'config.example.js'
          keep_files: false
